## ElasticSearch原理详解

### 1.概述

ElasticSearch（简称ES）是一款目前市面常用的搜索分析引擎，可以在短时间内完成海量数据的搜索。它基于Lucene，使用Java语言开发。Lucene的使用非常复杂，但是ES采用restful风格的api，对于开发者来说非常友好，上手简单。只需通过RestHighLevelClient即可完成各种复杂操作。

目前应用最为广泛的场景：

1. C端列表搜索，如百度、谷歌、淘宝、京东等。因为C端的列表搜索与数据库的查询不同，需要分析客户输入的关键词，然后再给出相应的结果。ES会将搜索词进行分析，通过分词、过滤等方式到索引库中匹配，匹配后根据得分排序。C端列表搜索是目前ES应用最广泛的场景，不仅可以使用ES本身的功能，还可以植入算法插件优化。
2. 类数据库查询。大型系统中会有很多数据查询的场景，有些复杂查询会关联多张数据库表，并且经常需要加新字段查询，这种查询使用数据库的话性能较低，支持的查询方式也较少。可建立搜索服务，使用ES作为搜索引擎，只需开发出公共搜索接口，根据入参生成查询DSL即可完成搜索。需要考虑数据同步的问题。
3. 线上日志监控。ELK体系，通过ES+Kibana+Logstash+Beats实现线上海量日志搜集和搜索。个人认为目前搭建ELK体系的项目其实不多，因为现在都是使用云服务器，不管是异常监控还是日志存储查询都在云服务商的网站就提供了。

本文将介绍ES的实现原理和分布式集群机制，不涉及Lucene部分。



### 2.倒排索引（Inverted Index）

#### 2.1.概念

提到ES原理，一定绕不开倒排索引，它是ES实现**全文检索和相关性排序的核心。**

* **什么是倒排索引**

  倒排是相对于类似MySQL数据库的正排索引而言的。

  正排索引是以文档对象的唯一ID作为索引，以文档内容作为记录。

  倒排索引恰恰相反，使用的是文档内容作为索引，ID作为记录。

* **分词**

  ES在存储数据时是会根据字段类型来区分是否分词的，字段定义为text类型就会被分词处理后再进行存储。

  ES内置了很多分词器，它们有不同的分词规则，当然也支持自定义分词，插件分词等等，对于中文支持比较好的就是IK分词器。

  例如：2023新款苹果手机，可能会被分词成为 2023、新款、苹果、手机、苹果手机等几个词存入。

  分词后才能实现全文检索和相关性排序，**分词后才会被记录到倒排索引里**。

  

#### 2.2.倒排索引结构

根据倒排索引的概念，我们可以用一个 Map来简单描述这个结构。这个 Map 的 Key 的即是分词后的单词，这里的单词称为 Term，这一系列的 Term 组成了倒排索引的第一个部分 —— **Term Dictionary** (索引表，可简称为 Dictionary)。

倒排索引的另一部分为 **Postings List**（记录表），也对应上述 Map 结构的 Value 部分集合。

记录表由所有的 Term 对应的数据（Postings） 组成，它不仅仅为文档 id 信息，可能包含以下信息：

**文档 id（DocId, Document Id）**，包含单词的所有文档唯一 id，用于去正排索引中查询原始数据。
**词频（TF，Term Frequency）**，记录 Term 在每篇文档中出现的次数，用于后续相关性算分。
**位置（Position）**，记录 Term 在每篇文档中的分词位置（多个），用于做词语搜索（Phrase Query）。
**偏移（Offset）**，记录 Term 在每篇文档的开始和结束位置，用于高亮显示等。

TODO 图